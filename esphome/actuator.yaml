esphome:
  name: radiant-heat-controller
  friendly_name: Radiant Heat Controller
  on_boot:
    priority: -100
    then:
      # Initialize all zones with global setpoint on boot
      - lambda: |-
          auto setpoint = id(global_setpoint).state;
          id(zone1_climate).target_temperature = setpoint;
          id(zone2_climate).target_temperature = setpoint;
          id(zone3_climate).target_temperature = setpoint;
          id(zone4_climate).target_temperature = setpoint;
          id(zone5_climate).target_temperature = setpoint;
          id(zone6_climate).target_temperature = setpoint;
          id(zone7_climate).target_temperature = setpoint;

# Global variable to track if pump should be running
globals:
  - id: pump_demand
    type: bool
    restore_value: no
    initial_value: 'false'

# Waveshare ESP32-S3-ETH-8DI-8RO board
# https://devices.esphome.io/devices/waveshare-esp32-s3-eth-8di-8do/
esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

logger:
  level: INFO

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

# Ethernet (W5500 on Waveshare board) - disabled, using WiFi instead
# ethernet:
#   type: W5500
#   clk_pin: GPIO15
#   mosi_pin: GPIO13
#   miso_pin: GPIO14
#   cs_pin: GPIO16
#   interrupt_pin: GPIO12
#   reset_pin: GPIO39

# WiFi as primary network interface
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "RadiantHeat Fallback"
    password: !secret fallback_ap_password

captive_portal:

web_server:
  port: 80

# I2C bus for PCA9554 (relay expander), DS2484 (1-wire master), and PCF85063 (RTC)
# Waveshare board I2C pins: SDA=GPIO42, SCL=GPIO41
i2c:
  sda: GPIO42
  scl: GPIO41
  scan: true
  frequency: 100kHz

# PCA9554 I/O expander for relay control (address 0x20)
# Waveshare board uses PCA9554; ESPHome's pca9554 component is register-compatible
pca9554:
  - id: relay_expander
    address: 0x20

# XL9535 I/O expander for additional zones (OPTIONAL - uncomment when adding expansion board)
# Address options: 0x20-0x27 depending on A0/A1/A2 pins
# xl9535:
#   - id: expansion_relays
#     address: 0x21  # Use different address than TCA9554

# DS2484 1-wire master for temperature sensors (Adafruit DS2484 breakout)
# Default I2C address: 0x18
one_wire:
  - platform: ds2484
    id: onewire_bus

# Global setpoint that can be applied to all zones (in Celsius)
number:
  - platform: template
    name: "Global Setpoint"
    id: global_setpoint
    unit_of_measurement: "°C"
    device_class: temperature
    optimistic: true
    min_value: 10
    max_value: 30
    step: 0.5
    initial_value: 20
    restore_value: true
    on_value:
      then:
        - lambda: |-
            // Only apply to zones that haven't been individually overridden
            // Users can set per-zone temps via HA which won't be overwritten
            ESP_LOGI("thermostat", "Global setpoint changed to %.1f°C", x);

  - platform: template
    name: "Apply Global Setpoint"
    id: apply_global_trigger
    unit_of_measurement: ""
    optimistic: true
    min_value: 0
    max_value: 1
    step: 1
    initial_value: 0
    on_value:
      then:
        - if:
            condition:
              lambda: 'return x == 1;'
            then:
              - lambda: |-
                  auto setpoint = id(global_setpoint).state;
                  id(zone1_climate).target_temperature = setpoint;
                  id(zone2_climate).target_temperature = setpoint;
                  id(zone3_climate).target_temperature = setpoint;
                  id(zone4_climate).target_temperature = setpoint;
                  id(zone5_climate).target_temperature = setpoint;
                  id(zone6_climate).target_temperature = setpoint;
                  id(zone7_climate).target_temperature = setpoint;
                  ESP_LOGI("thermostat", "Applied global setpoint %.1f°C to all zones", setpoint);
              - number.set:
                  id: apply_global_trigger
                  value: 0

  - platform: template
    name: "Pump Start Delay"
    id: pump_start_delay
    unit_of_measurement: "s"
    optimistic: true
    min_value: 0
    max_value: 60
    step: 1
    initial_value: 5
    restore_value: true

  - platform: template
    name: "Pump Stop Delay"
    id: pump_stop_delay
    unit_of_measurement: "s"
    optimistic: true
    min_value: 0
    max_value: 300
    step: 5
    initial_value: 30
    restore_value: true

# Hysteresis setting (configurable deadband)
  - platform: template
    name: "Thermostat Hysteresis"
    id: hysteresis
    unit_of_measurement: "°C"
    optimistic: true
    min_value: 0.5
    max_value: 3
    step: 0.5
    initial_value: 0.5
    restore_value: true

# Internal relay switches via TCA9554 expander
switch:
  - platform: gpio
    name: "Zone 1 Relay"
    id: zone1_relay
    pin:
      pca9554: relay_expander
      number: 0
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  - platform: gpio
    name: "Zone 2 Relay"
    id: zone2_relay
    pin:
      pca9554: relay_expander
      number: 1
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  - platform: gpio
    name: "Zone 3 Relay"
    id: zone3_relay
    pin:
      pca9554: relay_expander
      number: 2
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  - platform: gpio
    name: "Zone 4 Relay"
    id: zone4_relay
    pin:
      pca9554: relay_expander
      number: 3
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  - platform: gpio
    name: "Zone 5 Relay"
    id: zone5_relay
    pin:
      pca9554: relay_expander
      number: 4
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  - platform: gpio
    name: "Zone 6 Relay"
    id: zone6_relay
    pin:
      pca9554: relay_expander
      number: 5
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  - platform: gpio
    name: "Zone 7 Relay"
    id: zone7_relay
    pin:
      pca9554: relay_expander
      number: 6
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

  # Relay 8 (index 7) is used for circulation pump control
  - platform: gpio
    name: "Circulation Pump Relay"
    id: pump_relay
    pin:
      pca9554: relay_expander
      number: 7
      mode: OUTPUT
    restore_mode: RESTORE_DEFAULT_OFF
    internal: true

# Expansion zone relays via XL9535 (OPTIONAL - uncomment when adding expansion board)
# switch (continued):
#   - platform: gpio
#     name: "Zone 8 Relay"
#     id: zone8_relay
#     pin:
#       xl9535: expansion_relays
#       number: 0
#       mode: OUTPUT
#     restore_mode: RESTORE_DEFAULT_OFF
#     internal: true
#   - platform: gpio
#     name: "Zone 9 Relay"
#     id: zone9_relay
#     pin:
#       xl9535: expansion_relays
#       number: 1
#       mode: OUTPUT
#     restore_mode: RESTORE_DEFAULT_OFF
#     internal: true
#   # ... continue for zones 10-16 on pins 2-7 and 8-15

# Dallas/DS18B20 temperature sensors on the 1-wire bus
# NOTE: Replace the 0x0000000000000000 addresses with your actual sensor addresses
# Run once with these placeholders, check logs for discovered addresses, then update
sensor:
  - platform: dallas_temp
    one_wire_id: onewire_bus
    index: 0  # First discovered sensor - check logs for actual address
    name: "Zone 1 Temperature"
    id: zone1_temp
    unit_of_measurement: "°C"  # Convert C to F
    on_value:
      then:
        - lambda: |-
            id(zone1_climate).current_temperature = x;

  - platform: dallas_temp
    one_wire_id: onewire_bus
    index: 1  # Second discovered sensor - check logs for actual address
    name: "Zone 2 Temperature"
    id: zone2_temp
    unit_of_measurement: "°C"
    on_value:
      then:
        - lambda: |-
            id(zone2_climate).current_temperature = x;

  - platform: dallas_temp
    one_wire_id: onewire_bus
    address: 0x0000000000000003  # Replace with actual address
    name: "Zone 3 Temperature"
    id: zone3_temp
    unit_of_measurement: "°C"
    on_value:
      then:
        - lambda: |-
            id(zone3_climate).current_temperature = x;

  - platform: dallas_temp
    one_wire_id: onewire_bus
    address: 0x0000000000000004  # Replace with actual address
    name: "Zone 4 Temperature"
    id: zone4_temp
    unit_of_measurement: "°C"
    on_value:
      then:
        - lambda: |-
            id(zone4_climate).current_temperature = x;

  - platform: dallas_temp
    one_wire_id: onewire_bus
    address: 0x0000000000000005  # Replace with actual address
    name: "Zone 5 Temperature"
    id: zone5_temp
    unit_of_measurement: "°C"
    on_value:
      then:
        - lambda: |-
            id(zone5_climate).current_temperature = x;

  - platform: dallas_temp
    one_wire_id: onewire_bus
    address: 0x0000000000000006  # Replace with actual address
    name: "Zone 6 Temperature"
    id: zone6_temp
    unit_of_measurement: "°C"
    on_value:
      then:
        - lambda: |-
            id(zone6_climate).current_temperature = x;

  - platform: dallas_temp
    one_wire_id: onewire_bus
    address: 0x0000000000000007  # Replace with actual address
    name: "Zone 7 Temperature"
    id: zone7_temp
    unit_of_measurement: "°C"
    on_value:
      then:
        - lambda: |-
            id(zone7_climate).current_temperature = x;

# Zone 8 sensor available for expansion via XL9535
# Uncomment and add address when expansion board is installed
#   - platform: dallas_temp
#     one_wire_id: onewire_bus
#     address: 0x0000000000000008  # Replace with actual address
#     name: "Zone 8 Temperature"
#     id: zone8_temp
#     unit_of_measurement: "°F"
#     filters:
#       - lambda: return x * 9.0/5.0 + 32.0;
#     on_value:
#       then:
#         - lambda: |-
#             id(zone8_climate).current_temperature = x;

# Thermostat climate entities for each zone
climate:
  - platform: thermostat
    name: "Zone 1 Thermostat"
    id: zone1_climate
    sensor: zone1_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F in Celsius
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F in Celsius
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone1_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone1_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

  - platform: thermostat
    name: "Zone 2 Thermostat"
    id: zone2_climate
    sensor: zone2_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone2_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone2_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

  - platform: thermostat
    name: "Zone 3 Thermostat"
    id: zone3_climate
    sensor: zone3_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone3_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone3_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

  - platform: thermostat
    name: "Zone 4 Thermostat"
    id: zone4_climate
    sensor: zone4_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone4_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone4_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

  - platform: thermostat
    name: "Zone 5 Thermostat"
    id: zone5_climate
    sensor: zone5_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone5_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone5_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

  - platform: thermostat
    name: "Zone 6 Thermostat"
    id: zone6_climate
    sensor: zone6_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone6_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone6_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

  - platform: thermostat
    name: "Zone 7 Thermostat"
    id: zone7_climate
    sensor: zone7_temp
    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20  # 68°F
    min_heating_off_time: 60s
    min_heating_run_time: 60s
    min_idle_time: 30s
    heat_deadband: 0.5  # ~1°F
    heat_overrun: 0
    heat_action:
      - switch.turn_on: zone7_relay
      - script.execute: set_pump_demand
    idle_action:
      - switch.turn_off: zone7_relay
      - script.execute: set_pump_demand
    visual:
      min_temperature: 10  # 50°F
      max_temperature: 30  # 86°F
      temperature_step: 0.5

# Zone 8 thermostat available for expansion via XL9535
# Uncomment when expansion board is installed
#   - platform: thermostat
#     name: "Zone 8 Thermostat"
#     id: zone8_climate
#     sensor: zone8_temp
#     default_preset: Home
#     preset:
#       - name: Home
#         default_target_temperature_low: 68 °F
#     min_heating_off_time: 60s
#     min_heating_run_time: 60s
#     min_idle_time: 30s
#     heat_deadband: 1 °F
#     heat_overrun: 0 °F
#     heat_action:
#       - switch.turn_on: zone8_relay
#     idle_action:
#       - switch.turn_off: zone8_relay
#     visual:
#       min_temperature: 50 °F
#       max_temperature: 85 °F
#       temperature_step: 0.5 °F

# Valve feedback sensors (active when valve is open)
# These are used to interlock the circulation pump - pump only runs when at least one valve is confirmed open
# Waveshare board digital inputs DI1-DI8: GPIO4-GPIO11, active-low with internal pullups
binary_sensor:
  - platform: status
    name: "Controller Status"

  - platform: gpio
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 1 Valve Open"
    id: zone1_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  - platform: gpio
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 2 Valve Open"
    id: zone2_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  - platform: gpio
    pin:
      number: GPIO6
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 3 Valve Open"
    id: zone3_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  - platform: gpio
    pin:
      number: GPIO7
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 4 Valve Open"
    id: zone4_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  - platform: gpio
    pin:
      number: GPIO8
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 5 Valve Open"
    id: zone5_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  - platform: gpio
    pin:
      number: GPIO9
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 6 Valve Open"
    id: zone6_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  - platform: gpio
    pin:
      number: GPIO10
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Zone 7 Valve Open"
    id: zone7_valve
    device_class: opening
    filters:
      - delayed_on_off: 10ms
    on_state:
      then:
        - script.execute: update_pump_state

  # Digital Input 8 (DI8) available for future use (e.g., expansion zone valve feedback)
  - platform: gpio
    pin:
      number: GPIO11
      mode: INPUT_PULLUP
      inverted: true  # Active low
    name: "Digital Input 8"
    id: di8
    filters:
      - delayed_on_off: 10ms

  # Virtual sensor showing if any valve is open (for HA dashboard)
  - platform: template
    name: "Any Valve Open"
    id: any_valve_open
    device_class: opening
    lambda: |-
      return id(zone1_valve).state || id(zone2_valve).state || id(zone3_valve).state ||
             id(zone4_valve).state || id(zone5_valve).state || id(zone6_valve).state ||
             id(zone7_valve).state;

  # Pump running status (for HA dashboard)
  - platform: template
    name: "Circulation Pump Running"
    id: pump_running
    device_class: running
    lambda: |-
      return id(pump_relay).state;

# Pump control scripts
script:
  - id: update_pump_state
    mode: restart
    then:
      - lambda: |-
          // Check if any valve is open
          bool any_valve = id(zone1_valve).state || id(zone2_valve).state || id(zone3_valve).state ||
                           id(zone4_valve).state || id(zone5_valve).state || id(zone6_valve).state ||
                           id(zone7_valve).state;

          // Check if any zone is calling for heat (pump demand)
          bool heat_demand = id(pump_demand);

          if (heat_demand && any_valve) {
            // Demand exists and valve confirmed open - start pump after delay
            ESP_LOGI("pump", "Heat demand with valve open - starting pump after delay");
          } else if (!heat_demand) {
            // No heat demand - stop pump after delay
            ESP_LOGI("pump", "No heat demand - stopping pump after delay");
          } else {
            // Heat demand but no valve open yet - wait
            ESP_LOGI("pump", "Heat demand but waiting for valve to open");
          }
      - if:
          condition:
            lambda: |-
              bool any_valve = id(zone1_valve).state || id(zone2_valve).state || id(zone3_valve).state ||
                               id(zone4_valve).state || id(zone5_valve).state || id(zone6_valve).state ||
                               id(zone7_valve).state;
              return id(pump_demand) && any_valve;
          then:
            - delay: !lambda "return id(pump_start_delay).state * 1000;"
            - switch.turn_on: pump_relay
            - light.turn_on:
                id: status_led
                effect: "Heating Active"
                red: 100%
                green: 30%
                blue: 0%
          else:
            - if:
                condition:
                  lambda: 'return !id(pump_demand);'
                then:
                  - delay: !lambda "return id(pump_stop_delay).state * 1000;"
                  - switch.turn_off: pump_relay
                  - light.turn_on:
                      id: status_led
                      effect: none
                      red: 0%
                      green: 100%
                      blue: 0%

  - id: set_pump_demand
    mode: restart
    then:
      - lambda: |-
          // Check if any zone thermostat is actively heating
          bool demand = false;
          auto z1_action = id(zone1_climate).action;
          auto z2_action = id(zone2_climate).action;
          auto z3_action = id(zone3_climate).action;
          auto z4_action = id(zone4_climate).action;
          auto z5_action = id(zone5_climate).action;
          auto z6_action = id(zone6_climate).action;
          auto z7_action = id(zone7_climate).action;

          if (z1_action == climate::CLIMATE_ACTION_HEATING ||
              z2_action == climate::CLIMATE_ACTION_HEATING ||
              z3_action == climate::CLIMATE_ACTION_HEATING ||
              z4_action == climate::CLIMATE_ACTION_HEATING ||
              z5_action == climate::CLIMATE_ACTION_HEATING ||
              z6_action == climate::CLIMATE_ACTION_HEATING ||
              z7_action == climate::CLIMATE_ACTION_HEATING) {
            demand = true;
          }

          id(pump_demand) = demand;
          ESP_LOGI("pump", "Pump demand updated: %s", demand ? "true" : "false");
      - script.execute: update_pump_state

# RGB status LED (WS2812)
light:
  - platform: esp32_rmt_led_strip
    rgb_order: RGB
    chipset: WS2812
    pin: GPIO38
    num_leds: 1
    name: "Status LED"
    id: status_led
    effects:
      - pulse:
          name: "Heating Active"
          transition_length: 1s
          update_interval: 1s
      - strobe:
          name: "Fast Blink"
          colors:
            - state: true
              duration: 200ms
            - state: false
              duration: 200ms

# Time sync for logging
time:
  - platform: sntp
    id: sntp_time
    timezone: America/Los_Angeles

# Periodic status logging and LED updates
interval:
  - interval: 10s
    then:
      - lambda: |-
          // Log network status and IP address
          if (wifi::global_wifi_component->is_connected()) {
            auto ips = wifi::global_wifi_component->get_ip_addresses();
            if (!ips.empty()) {
              ESP_LOGI("status", "WiFi connected - IP: %s, RSSI: %d dBm",
                       ips[0].str().c_str(),
                       wifi::global_wifi_component->wifi_rssi());
            }
          } else {
            ESP_LOGW("status", "WiFi disconnected - attempting to connect...");
          }

          // Log sensor status
          ESP_LOGI("status", "Zone1: %.1f°C, Zone2: %.1f°C",
                   id(zone1_temp).state, id(zone2_temp).state);

          // Update LED based on status
          if (!wifi::global_wifi_component->is_connected()) {
            // Red blink = no WiFi
            auto call = id(status_led).turn_on();
            call.set_rgb(1.0, 0.0, 0.0);
            call.set_effect("Fast Blink");
            call.perform();
          } else if (id(pump_demand)) {
            // Orange pulse = heating active
            auto call = id(status_led).turn_on();
            call.set_rgb(1.0, 0.3, 0.0);
            call.set_effect("Heating Active");
            call.perform();
          } else {
            // Green = connected and idle
            auto call = id(status_led).turn_on();
            call.set_rgb(0.0, 1.0, 0.0);
            call.set_brightness(0.3);
            call.set_effect("none");
            call.perform();
          }

# SPI bus for TFT display (using SD Card header pins)
# SD Card header: SCLK=GPIO48, MOSI=GPIO47, MISO=GPIO45 (repurposed as CS)
spi:
  - id: display_spi
    clk_pin: GPIO48   # SD Card SCLK
    mosi_pin: GPIO47  # SD Card MOSI

# Fonts for display
font:
  - file: "gfonts://Roboto"
    id: font_large
    size: 16
  - file: "gfonts://Roboto"
    id: font_medium
    size: 12
  - file: "gfonts://Roboto"
    id: font_small
    size: 10

# 2.2" ILI9341 TFT Display (320x240)
display:
  - platform: ili9xxx
    model: ILI9341
    spi_id: display_spi
    cs_pin: GPIO45    # SD Card MISO (repurposed, display is write-only)
    dc_pin: GPIO21
    reset_pin: GPIO1
    dimensions: [320, 240]
    rotation: 0
    invert_colors: false
    update_interval: 1s
    lambda: |-
      // Colors
      auto WHITE = Color(255, 255, 255);
      auto BLACK = Color(0, 0, 0);
      auto RED = Color(255, 0, 0);
      auto GREEN = Color(0, 255, 0);
      auto ORANGE = Color(255, 165, 0);
      auto GRAY = Color(128, 128, 128);
      auto DARK_GRAY = Color(64, 64, 64);

      // Clear screen
      it.fill(BLACK);

      // Zone box dimensions: 8 boxes across top (7 zones + pump)
      int box_width = 40;
      int box_height = 80;
      int box_spacing = 0;

      // Draw zone boxes
      for (int i = 0; i < 7; i++) {
        int x = i * box_width;

        // Get zone data
        float temp = 0;
        bool relay_on = false;
        bool valve_open = false;
        bool heating = false;

        switch (i) {
          case 0:
            temp = id(zone1_temp).state;
            relay_on = id(zone1_relay).state;
            valve_open = id(zone1_valve).state;
            heating = id(zone1_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
          case 1:
            temp = id(zone2_temp).state;
            relay_on = id(zone2_relay).state;
            valve_open = id(zone2_valve).state;
            heating = id(zone2_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
          case 2:
            temp = id(zone3_temp).state;
            relay_on = id(zone3_relay).state;
            valve_open = id(zone3_valve).state;
            heating = id(zone3_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
          case 3:
            temp = id(zone4_temp).state;
            relay_on = id(zone4_relay).state;
            valve_open = id(zone4_valve).state;
            heating = id(zone4_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
          case 4:
            temp = id(zone5_temp).state;
            relay_on = id(zone5_relay).state;
            valve_open = id(zone5_valve).state;
            heating = id(zone5_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
          case 5:
            temp = id(zone6_temp).state;
            relay_on = id(zone6_relay).state;
            valve_open = id(zone6_valve).state;
            heating = id(zone6_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
          case 6:
            temp = id(zone7_temp).state;
            relay_on = id(zone7_relay).state;
            valve_open = id(zone7_valve).state;
            heating = id(zone7_climate).action == climate::CLIMATE_ACTION_HEATING;
            break;
        }

        // Box background color based on heating state
        Color bg_color = heating ? ORANGE : DARK_GRAY;
        it.filled_rectangle(x, 0, box_width - 1, box_height, bg_color);
        it.rectangle(x, 0, box_width - 1, box_height, WHITE);

        // Zone number
        it.printf(x + 2, 2, id(font_medium), WHITE, "Z%d", i + 1);

        // Temperature
        if (!std::isnan(temp)) {
          it.printf(x + 2, 18, id(font_large), WHITE, "%.0f", temp);
        } else {
          it.print(x + 2, 18, id(font_medium), GRAY, "--");
        }

        // Relay status (R: commanded)
        it.printf(x + 2, 40, id(font_small), relay_on ? GREEN : GRAY, "R:%s", relay_on ? "ON" : "off");

        // Valve status (V: observed)
        it.printf(x + 2, 52, id(font_small), valve_open ? GREEN : GRAY, "V:%s", valve_open ? "OPN" : "cls");

        // Status indicator
        if (heating && valve_open) {
          it.filled_circle(x + box_width/2, 70, 4, GREEN);
        } else if (heating && !valve_open) {
          it.filled_circle(x + box_width/2, 70, 4, ORANGE);
        } else {
          it.filled_circle(x + box_width/2, 70, 4, DARK_GRAY);
        }
      }

      // Pump box (8th position)
      int pump_x = 7 * box_width;
      bool pump_on = id(pump_relay).state;
      Color pump_bg = pump_on ? ORANGE : DARK_GRAY;
      it.filled_rectangle(pump_x, 0, box_width - 1, box_height, pump_bg);
      it.rectangle(pump_x, 0, box_width - 1, box_height, WHITE);
      it.print(pump_x + 4, 2, id(font_medium), WHITE, "PUMP");
      it.printf(pump_x + 4, 30, id(font_large), pump_on ? GREEN : GRAY, "%s", pump_on ? "ON" : "OFF");
      it.filled_circle(pump_x + box_width/2, 70, 4, pump_on ? GREEN : DARK_GRAY);

      // Status bar below zones
      int status_y = box_height + 5;

      // Network status
      it.print(5, status_y, id(font_medium), WHITE, "Network:");
      if (wifi::global_wifi_component->is_connected()) {
        it.print(70, status_y, id(font_medium), GREEN, "WiFi");
        auto ips = wifi::global_wifi_component->get_ip_addresses();
        if (!ips.empty()) {
          it.printf(110, status_y, id(font_small), WHITE, "%s", ips[0].str().c_str());
        }
      } else {
        it.print(70, status_y, id(font_medium), RED, "DISCONNECTED");
      }

      // Pump demand status
      int demand_y = status_y + 16;
      it.print(5, demand_y, id(font_medium), WHITE, "Demand:");
      it.printf(60, demand_y, id(font_medium), id(pump_demand) ? ORANGE : GRAY, "%s", id(pump_demand) ? "ACTIVE" : "idle");

      // Valve summary
      int any_valve = id(zone1_valve).state || id(zone2_valve).state || id(zone3_valve).state ||
                      id(zone4_valve).state || id(zone5_valve).state || id(zone6_valve).state ||
                      id(zone7_valve).state;
      it.print(140, demand_y, id(font_medium), WHITE, "Valves:");
      it.printf(195, demand_y, id(font_medium), any_valve ? GREEN : GRAY, "%s", any_valve ? "OPEN" : "closed");

      // Time
      int time_y = demand_y + 16;
      if (id(sntp_time).now().is_valid()) {
        it.strftime(5, time_y, id(font_medium), WHITE, "%Y-%m-%d %H:%M:%S", id(sntp_time).now());
      }

      // Global setpoint
      it.printf(200, time_y, id(font_medium), WHITE, "Set: %.0f°C", id(global_setpoint).state);
